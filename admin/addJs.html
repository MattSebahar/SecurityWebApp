<script>
  /**
   * This script handles the functionality for adding new 2FA secrets and managing users.
   * It includes QR code scanning, form validation, and user management features.
   * 
   * @author Matt Sebahar
   * @copyright Startupbootcamp Australia
   * @date 24.07.2025
   */

    // Global variable to track edit mode
      let isEditMode = false;
      let editingCompany = null;
      let editingEmail = null;

      /**
     * Handles the file selection event for the QR code.
     * @param {Event} event The file input change event.
     */
      function handleQrCodeFile(event) {
        const file = event.target.files[0];
        
        if (!file) {
          return;
        }

        
        const reader = new FileReader();

        reader.onload = function (e) {
          const img = new Image();
          img.onload = function () {
            const canvas = document.getElementById('qr-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0, img.width, img.height);
            const imageData = ctx.getImageData(0, 0, img.width, img.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);

            if (code) {
              try {
                const url = new URL(code.data);
                const secret = url.searchParams.get('secret');
                const issuer = url.searchParams.get('issuer') || url.pathname.split(':').pop().split('/')[0].trim();
                const account = decodeURIComponent(url.pathname).split(':').pop().split('/').pop().trim();

                if (secret) {
                  document.getElementById('secretSeed').value = secret;
                  document.getElementById('company').value = issuer || '';
                  document.getElementById('email').value = account || '';
                  showFeedbackPopup('QR Code decoded successfully!', 'success');
                } else {
                  throw new Error("'secret' parameter not found in QR code.");
                }
              } catch (err) {
                console.error("Error parsing QR code URL:", err);
                showFeedbackPopup('Error: Invalid QR code format.', 'error');
              }
            } else {
              showFeedbackPopup('Error: No QR code found in image.', 'error');
            }
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }

      /**
       * Gathers data from the form and calls the server-side save function.
       */
      function saveNewSecret() {
        const company = document.getElementById('company').value.trim();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();
        const seed = document.getElementById('secretSeed').value.trim().replace(/\s/g, ''); // Remove spaces

        // Different validation for edit mode vs add mode
        if (isEditMode) {
          // In edit mode, seed is not required and should be ignored
          if (!company || !email) {
            showFeedbackPopup('Company and email are required.', 'error');
            return;
          }
        } else {
          // In add mode, all fields except password are required
          if (!company || !email || !seed) {
            showFeedbackPopup('Company, email, and secret seed are required.', 'error');
            return;
          }
        }

        let data;

        if (isEditMode) {
          // For updates, send original identifiers and new data
          data = {
            isUpdate: true,
            originalCompany: editingCompany,
            originalEmail: editingEmail,
            newCompany: company,
            newEmail: email
          };

          // Encrypt password if provided
          if (password) {
            data.encryptedPassword = encryptWithCredentials(password, company, email);
          }
        } else {
          // For new entries, encrypt data before sending
          const encryptedSeed = encryptWithCredentials(seed, company, email);
          const secretHash = generateSecretHash(seed, company, email);
          
          data = {
            isUpdate: false,
            company,
            email,
            encryptedSeed: encryptedSeed,
            secretHash: secretHash
          };

          // Encrypt password if provided
          if (password) {
            data.encryptedPassword = encryptWithCredentials(password, company, email);
          }
        }

        google.script.run
          .withSuccessHandler(response => {
            if (response.success) {
              showFeedbackPopup(response.message, 'success');

              // Reset form to add mode
              resetFormToAddMode();

              // Refresh the codes list
              loadCodesList();

              // Only redirect to home for new entries, not updates
              if (response.message.includes('saved securely')) {
                document.getElementById('ok-button').textContent = 'Return to Home';

                // Redirect home after a delay
                setTimeout(() => {
                  window.top.location.href = '<?= ScriptApp.getService().getUrl(); ?>';
                }, 1000);
              }
            } else {
              showFeedbackPopup('Error: ' + response.message, 'error');
            }
          })
          .withFailureHandler(error => {
            showFeedbackPopup('Error: ' + error.message, 'error');
            console.error('Save failed:', error);
          })
          .saveSecret(data);
      }

    /**
     * Save a new user group
     */
    function saveNewUserGroup() {
      const groupName = document.getElementById('group-name').value.trim();

      if (!groupName) {
        showFeedbackPopup('User group name is required.', 'error');
        return;
      }

      google.script.run
        .withSuccessHandler(response => {
          if (response.success) {
            showFeedbackPopup(response.message, 'success');
            document.getElementById('group-name').value = ''; // Clear input
            loadUsersList(); // Refresh the user/group list
          } else {
            showFeedbackPopup('Error: ' + response.message, 'error');
          }
        })
        .withFailureHandler(error => {
          showFeedbackPopup('Error: ' + error.message, 'error');
          console.error('Save user group failed:', error);
        })
        .saveUserGroup(groupName);
    }

    /**
     * Load users and groups into the select dropdown
     */
    function loadUsersList() {
      google.script.run
        .withSuccessHandler(data => {
          const { users, userGroups } = data;
          const select = document.getElementById('user-select');
          
          // Clear existing options except the first one
          select.innerHTML = '<option value="">-- Select a user or group --</option>';
          
          
          
          // Add individual users
          if (users && Object.keys(users).length > 0) {
            const userOptGroup = document.createElement('optgroup');
            userOptGroup.label = 'Users';
            
            Object.keys(users).forEach(userEmail => {
              const option = document.createElement('option');
              option.value = userEmail;
              // Use name if available, otherwise fallback to email (stripped)
              const displayName = users[userEmail].name || userEmail.replace('@startupbootcamp.com.au', '');
              option.textContent = displayName;
              userOptGroup.appendChild(option);
            });
            
            select.appendChild(userOptGroup);
          }

          // Add user groups last
          if (userGroups && Object.keys(userGroups).length > 0) {
            const groupOptGroup = document.createElement('optgroup');
            groupOptGroup.label = 'User Groups';
            
            // Sort groups to put DEFAULT first
            const sortedGroups = Object.keys(userGroups).sort((a, b) => {
              if (a === 'DEFAULT') return -1;
              if (b === 'DEFAULT') return 1;
              return a.localeCompare(b);
            });
            
            sortedGroups.forEach(groupName => {
              const option = document.createElement('option');
              option.value = `GROUP:${groupName}`;
              option.textContent = `${groupName}`;
              groupOptGroup.appendChild(option);
            });
            
            select.appendChild(groupOptGroup);
          }
        })
        .withFailureHandler(error => {
          console.error('Error loading users and groups:', error);
          showFeedbackPopup('Error loading users and groups list.', 'error');
        })
        .getUsersAndGroups();
    }

    /**
     * Load permissions for selected user or group
     */
    function loadUserPermissions() {
      const selectedValue = document.getElementById('user-select').value;
      const permissionsContainer = document.getElementById('user-permissions-container');
      
      if (!selectedValue) {
        permissionsContainer.style.display = 'none';
        return;
      }
      
      // Show loading message immediately
      permissionsContainer.style.display = 'block';
      permissionsContainer.innerHTML = '<p class="loading-message">Fetching current status...</p>';
      
      const isGroup = selectedValue.startsWith('GROUP:');
      const identifier = isGroup ? selectedValue.substring(6) : selectedValue; // Remove 'GROUP:' prefix
      
      google.script.run
        .withSuccessHandler(data => {
          const { users, userGroups, secrets } = data;
          let permissions;
          
          if (isGroup) {
            permissions = userGroups[identifier];
            if (!permissions) {
              showFeedbackPopup('User group permissions not found.', 'error');
              permissionsContainer.style.display = 'none';
              return;
            }
          } else {
            permissions = users[identifier];
            if (!permissions) {
              showFeedbackPopup('User permissions not found.', 'error');
              permissionsContainer.style.display = 'none';
              return;
            }
          }
          
          // Clear loading message and restore original structure
          permissionsContainer.innerHTML = `
            <!-- User Name Field (for users only) -->
            <div id="user-name-section" class="user-name-section" style="display: ${isGroup ? 'none' : 'block'}; margin-top: 10px;">
              <h4 class='mini-header'>Display Name:</h4>
              <input type="text" id="selected-user-name" class="user-name-input" placeholder="Enter display name" maxlength="50">
              <button class="button-secondary-small" onclick="saveUserName()">Update Name</button>
            </div>

            <!-- Group Members List (for groups only) -->
            <div id="group-members-section" class="group-members-section" style="display: ${isGroup ? 'block' : 'none'}; margin-top: 10px;">
              <h4 class='mini-header'>Group Members:</h4>
              <div id="group-members-list" class="group-members-list">
                <!-- Group members will be populated here -->
              </div>
            </div>

            <div class="user-groups-flex">
              <div id="user-groups-container" class="user-groups-container">
                <!-- User group radios will be populated here -->
              </div>
            </div>
            
            <h4 class='mini-header'>Card Permissions:</h4>
            <div id="card-permissions-container" class="card-permissions-container">
              <!-- Card permissions will be populated here -->
            </div>
            
            <div class="form-actions">
              <button onclick="saveUserPermissions()">Save Permissions</button>
              <button class="secondary" id="remove-button" onclick="removeSelectedUser()">${isGroup ? 'Remove Group' : 'Remove User'}</button>
            </div>
          `;

          // Load user name if it's a user (not a group)
          if (!isGroup && permissions.name) {
            document.getElementById('selected-user-name').value = permissions.name;
          }

          // Load group members if it's a group
          if (isGroup) {
            loadGroupMembers(users, identifier);
          }

          // Load user groups (only for users, not for groups themselves)
          loadUserGroups(userGroups, permissions.isAdmin ? 'ADMIN' : permissions.userGroup, isGroup);
          
          // Load card permissions
          loadCardPermissions(secrets, permissions.cardPermissions, permissions.isAdmin, permissions.userGroup, userGroups, isGroup);
          
          // For initial load, just update admin state without triggering group reload
          if (!isGroup && permissions.isAdmin) {
            const cardCheckboxes = document.querySelectorAll('#card-permissions-container input[type="checkbox"]');
            cardCheckboxes.forEach(checkbox => {
              checkbox.checked = true;
              checkbox.disabled = true;
              checkbox.style.backgroundColor = '';
            });
          }
        })
        .withFailureHandler(error => {
          console.error('Error loading permissions:', error);
          showFeedbackPopup('Error loading permissions.', 'error');
          permissionsContainer.style.display = 'none';
        })
        .getUserPerms();
    }

    /**
     * Load group members list (only for groups)
     */
    function loadGroupMembers(users, groupName) {
      const container = document.getElementById('group-members-list');
      container.innerHTML = '';
      
      if (!users || Object.keys(users).length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No members in this group.</p>';
        return;
      }
      
      // Find users that belong to this group
      const groupMembers = Object.keys(users).filter(userEmail => {
        const user = users[userEmail];
        return user.userGroup === groupName;
      });
      
      if (groupMembers.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No members in this group.</p>';
        return;
      }
      
      groupMembers.forEach(userEmail => {
        const user = users[userEmail];
        const memberDiv = document.createElement('div');
        memberDiv.style.marginBottom = '4px';
        memberDiv.style.padding = '4px 8px';
        memberDiv.style.backgroundColor = '#f8f9fa';
        memberDiv.style.borderRadius = '4px';
        memberDiv.style.fontSize = '14px';
        
        const displayName = user.name || userEmail.replace('@startupbootcamp.com.au', '');
        memberDiv.textContent = `${displayName} (${userEmail})`;
        
        container.appendChild(memberDiv);
      });
    }

    /**
     * Load user groups checkboxes (only for individual users)
     */
    function loadUserGroups(userGroups, currentUserGroup, isGroup) {
      const container = document.getElementById('user-groups-container');
      container.innerHTML = '';
      
      // Don't show user groups for group management
      if (isGroup) 
        return;
      
      if (!userGroups || Object.keys(userGroups).length === 0)
        return;
      
      // Add "Admin" option first
      const adminLabel = document.createElement('label');
      adminLabel.style.display = 'flex';
      adminLabel.style.alignItems = 'center';
      adminLabel.style.gap = '8px';

      const adminRadio = document.createElement('input');
      adminRadio.type = 'radio';
      adminRadio.name = 'userGroup';
      adminRadio.value = 'ADMIN';
      adminRadio.checked = currentUserGroup === 'ADMIN';
      adminRadio.onchange = toggleAdminPermissions;

      const adminText = document.createTextNode('ADMIN');

      adminLabel.appendChild(adminRadio);
      adminLabel.appendChild(adminText);
      container.appendChild(adminLabel);

      // Create radio buttons for each user group
      Object.keys(userGroups).forEach(groupName => {
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        
        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = 'userGroup';
        radio.value = groupName;
        radio.checked = currentUserGroup === groupName;
        radio.onchange = toggleAdminPermissions;
        
        const text = document.createTextNode(groupName);
        
        label.appendChild(radio);
        label.appendChild(text);
        container.appendChild(label);
      });
    }

    /**
     * Load card permissions checkboxes
     */
    function loadCardPermissions(secrets, cardPermissions, isAdmin, userGroup, userGroups, isGroup = false, showOnlyGroupPermissions = false) {
      const container = document.getElementById('card-permissions-container');
      container.innerHTML = '';
      
      if (!secrets || secrets.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No cards available.</p>';
        return;
      }
      
      // Get group permissions if user is part of a group, or use DEFAULT
      let groupPermissions = {};
      let groupName = userGroup;
      if (userGroup && userGroups && userGroups[userGroup]) {
        groupPermissions = userGroups[userGroup].cardPermissions || {};
      } else if (!userGroup && userGroups && userGroups['DEFAULT']) {
        // Use DEFAULT permissions if user has no group
        groupPermissions = userGroups['DEFAULT'].cardPermissions || {};
        groupName = 'DEFAULT';
      }
      
      secrets.forEach(secret => {
        const cardId = `${secret.company}-${secret.email}`;
        const hasGroupPermission = groupPermissions[cardId];
        const hasIndividualPermission = cardPermissions[cardId];
        
        let isChecked, isDisabled;
        
        if (isGroup) {
          // For groups: show current group permissions, all enabled
          isChecked = hasIndividualPermission || false;
          isDisabled = false;
        } else if (showOnlyGroupPermissions) {
          // Show only group permissions (used when radio button changes)
          isChecked = hasGroupPermission || false;
          isDisabled = hasGroupPermission || false;
        } else {
          // For users: check if admin or has individual permission
          isChecked = isAdmin || hasIndividualPermission;
          isDisabled = isAdmin;
          
          // If user has group permission, check and disable that checkbox
          if (hasGroupPermission) {
            isChecked = true;
            isDisabled = true;
          }
        }
        
        const checkboxDiv = document.createElement('div');
        checkboxDiv.style.marginBottom = '8px';
        
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `card-${cardId}`;
        checkbox.checked = isChecked;
        checkbox.disabled = isDisabled;
        
        // Add visual indicator for group permissions
        let displayText = `${secret.company} (${secret.email})`;
        if (!isGroup && hasGroupPermission && (showOnlyGroupPermissions || !hasIndividualPermission)) {
          if (groupName === 'DEFAULT') {
            checkbox.style.backgroundColor = '#FFF8E1';
          } else {
            checkbox.style.backgroundColor = '#E8F5F8';
          }
        } else {
          // Clear any background styling for groups or individual permissions
          checkbox.style.backgroundColor = '';
        }
        
        const text = document.createTextNode(displayText);
        
        label.appendChild(checkbox);
        label.appendChild(text);
        checkboxDiv.appendChild(label);
        container.appendChild(checkboxDiv);
      });
    }

    /**
     * Toggle admin permissions and update card permissions based on selected group
     */
    function toggleAdminPermissions() {
      const selectedGroupRadio = document.querySelector('input[name="userGroup"]:checked');
      const selectedGroup = selectedGroupRadio ? selectedGroupRadio.value : '';
      const isAdmin = selectedGroup === 'ADMIN';
      const selectedValue = document.getElementById('user-select').value;
      const isGroup = selectedValue.startsWith('GROUP:');
      
      // Don't trigger for group management - groups don't have radio buttons
      if (isGroup) {
        return;
      }
      
      // Show loading message immediately
      const container = document.getElementById('card-permissions-container');
      container.innerHTML = '<p style="text-align: center; color: #666; font-style: italic; margin: 20px 0;">Gathering Permissions...</p>';
      
      // If admin is selected, check and disable all checkboxes
      if (isAdmin) {
        // Small delay to show the loading message
        setTimeout(() => {
          // Reload the full UI to get fresh checkboxes
          google.script.run
            .withSuccessHandler(data => {
              const { secrets } = data;
              
              // Clear container and rebuild checkboxes
              container.innerHTML = '';
              
              secrets.forEach(secret => {
                const cardId = `${secret.company}-${secret.email}`;
                
                const checkboxDiv = document.createElement('div');
                checkboxDiv.style.marginBottom = '8px';
                
                const label = document.createElement('label');
                label.style.display = 'flex';
                label.style.alignItems = 'center';
                label.style.gap = '8px';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `card-${cardId}`;
                checkbox.checked = true;
                checkbox.disabled = true;
                checkbox.style.backgroundColor = '';
                
                const text = document.createTextNode(`${secret.company} (${secret.email})`);
                
                label.appendChild(checkbox);
                label.appendChild(text);
                checkboxDiv.appendChild(label);
                container.appendChild(checkboxDiv);
              });
            })
            .withFailureHandler(error => {
              console.error('Error reloading permissions:', error);
              container.innerHTML = '<p style="text-align: center; color: #dc3545; margin: 20px 0;">Error loading permissions.</p>';
            })
            .getUserPerms();
        }, 100);
        return;
      }
      
      // For non-admin groups, reload permissions to reflect ONLY the new group's access
      google.script.run
        .withSuccessHandler(data => {
          const { userGroups, secrets } = data;
          
          // Get the selected group's permissions (or DEFAULT if no group selected)
          let targetGroupPermissions = {};
          if (selectedGroup && userGroups && userGroups[selectedGroup]) {
            targetGroupPermissions = userGroups[selectedGroup].cardPermissions || {};
          } else if (!selectedGroup && userGroups && userGroups['DEFAULT']) {
            targetGroupPermissions = userGroups['DEFAULT'].cardPermissions || {};
          }
          
          // Clear container and rebuild checkboxes
          container.innerHTML = '';
          
          secrets.forEach(secret => {
            const cardId = `${secret.company}-${secret.email}`;
            const hasGroupPermission = targetGroupPermissions[cardId];
            
            const checkboxDiv = document.createElement('div');
            checkboxDiv.style.marginBottom = '8px';
            
            const label = document.createElement('label');
            label.style.display = 'flex';
            label.style.alignItems = 'center';
            label.style.gap = '8px';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `card-${cardId}`;
            checkbox.checked = hasGroupPermission || false;
            checkbox.disabled = hasGroupPermission || false;
            checkbox.style.backgroundColor = hasGroupPermission ? (selectedGroup === 'DEFAULT' ? '#FFF8E1' : '#E8F5F8') : '';
            
            const text = document.createTextNode(`${secret.company} (${secret.email})`);
            
            label.appendChild(checkbox);
            label.appendChild(text);
            checkboxDiv.appendChild(label);
            container.appendChild(checkboxDiv);
          });
        })
        .withFailureHandler(error => {
          console.error('Error reloading permissions:', error);
          container.innerHTML = '<p style="text-align: center; color: #dc3545; margin: 20px 0;">Error loading permissions.</p>';
        })
        .getUserPerms();
    }

    /**
     * Save user or group permissions
     */
    function saveUserPermissions() {
      const selectedValue = document.getElementById('user-select').value;
      if (!selectedValue) {
        showFeedbackPopup('No user or group selected.', 'error');
        return;
      }
      
      const isGroup = selectedValue.startsWith('GROUP:');
      const identifier = isGroup ? selectedValue.substring(6) : selectedValue;
      
      // Get admin status and user group from radio selection
      const selectedGroupRadio = document.querySelector('input[name="userGroup"]:checked');
      const selectedGroup = selectedGroupRadio ? selectedGroupRadio.value : '';
      const isAdmin = selectedGroup === 'ADMIN';
      
      const cardPermissions = {};
      
      // Collect card permissions
      const cardCheckboxes = document.querySelectorAll('#card-permissions-container input[type="checkbox"]');
      cardCheckboxes.forEach(checkbox => {
        const cardId = checkbox.id.replace('card-', '');
        cardPermissions[cardId] = checkbox.checked;
      });
      
      const permissions = {
        isAdmin: isAdmin,
        cardPermissions: cardPermissions
      };
      
      // Add user group for individual users (not for groups themselves)
      if (!isGroup) {
        // Set userGroup to empty string if admin, otherwise use selected group
        permissions.userGroup = isAdmin ? '' : selectedGroup;
      }
      
      google.script.run
        .withSuccessHandler(response => {
          if (response.success) {
            showFeedbackPopup(response.message, 'success');
          } else {
            showFeedbackPopup('Error: ' + response.message, 'error');
          }
        })
        .withFailureHandler(error => {
          showFeedbackPopup('Error: ' + error.message, 'error');
          console.error('Save permissions failed:', error);
        })
        .updateUserPermissions(identifier, permissions, isGroup);
    }

    /**
     * Remove selected user or group
     */
    function removeSelectedUser() {
      const selectedValue = document.getElementById('user-select').value;
      if (!selectedValue) {
        showFeedbackPopup('No user or group selected.', 'error');
        return;
      }
      
      const isGroup = selectedValue.startsWith('GROUP:');
      const identifier = isGroup ? selectedValue.substring(6) : selectedValue;
      const displayName = isGroup ? identifier : identifier.replace('@startupbootcamp.com.au', '');
      const itemType = isGroup ? 'group' : 'user';
      
      // Prevent deletion of DEFAULT or ADMIN group
      if (isGroup && (identifier === 'DEFAULT' || identifier === 'ADMIN')) {
        showFeedbackPopup('The ' + identifier + ' group cannot be removed as it is required for system permissions.', 'error');
        return;
      }

      if (!confirm(`Are you sure you want to remove the ${itemType} "${displayName}"?`)) 
        return;
      
      google.script.run
        .withSuccessHandler(response => {
          if (response.success) {
            showFeedbackPopup(response.message, 'success');
            // Reset the form
            document.getElementById('user-select').value = '';
            document.getElementById('user-permissions-container').style.display = 'none';
            loadUsersList(); // Refresh the list
          } else {
            showFeedbackPopup('Error: ' + response.message, 'error');
          }
        })
        .withFailureHandler(error => {
          showFeedbackPopup('Error: ' + error.message, 'error');
          console.error('Remove failed:', error);
        })
        .removeUser(identifier, isGroup);
    }      /**
       * Show feedback popup with message
       */
      function showFeedbackPopup(message, type = 'info') {
        const popup = document.getElementById('feedback-popup');
        const overlay = document.getElementById('feedback-overlay');
        const messageDiv = document.getElementById('feedback-message');

        messageDiv.textContent = message;
        messageDiv.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#30454A';

        overlay.style.display = 'block';
        popup.style.display = 'block';
      }

      /**
       * Hide feedback popup
       */
      function hideFeedbackPopup() {
        document.getElementById('feedback-overlay').style.display = 'none';
        document.getElementById('feedback-popup').style.display = 'none';
      }

    /**
     * Load admin list when page loads
     */
    window.addEventListener('load', function() {
      loadUsersList();
      loadCodesList();
    });

      /**
       * Load and display the current 2FA codes list as pills
       */
      function loadCodesList() {
        const container = document.getElementById('codes-list-container');
        
        // Show initial loading message
        container.innerHTML = '<p style="text-align: center; color: #666; font-style: italic; margin: 0;">Loading secrets...</p>';
        
        // After 1 second, change to checking permissions
        setTimeout(() => {
          container.innerHTML = '<p style="text-align: center; color: #666; font-style: italic; margin: 0;">Checking permissions...</p>';
        }, 1000);
        
        google.script.run
          .withSuccessHandler(secrets => {
            if (!secrets || secrets.length === 0) {
              container.innerHTML = '<p style="text-align: center; color: #666; font-style: italic; margin: 0;">No 2FA codes added yet.</p>';
              return;
            }

            // Clear existing pills
            container.innerHTML = '';

            secrets.forEach(secret => {
              addCodePill(secret.company, secret.email);
            });
          })
          .withFailureHandler(error => {
            console.error('Error loading codes list:', error);
            container.innerHTML =
              '<p style="text-align: center; color: #dc3545; margin: 0;">Error loading codes list.</p>';
          })
          .getSecretsData();
      }

      /**
       * Add a code pill to the container
       */
      function addCodePill(company, email) {
        const container = document.getElementById('codes-list-container');

        // Create pill element
        const pill = document.createElement('div');
        pill.className = 'code-pill';
        pill.dataset.company = company;
        pill.dataset.email = email;
        pill.textContent = company || 'Unknown Company';

        // Make the pill clickable to populate form fields
        pill.onclick = (e) => {
          // Don't trigger if clicking the remove button
          if (e.target.classList.contains('remove-pill')) {
            return;
          }
          populateFormFields(company, email);
        };

        // Create remove button
        const removeBtn = document.createElement('span');
        removeBtn.className = 'remove-pill';
        removeBtn.innerHTML = '×';
        removeBtn.onclick = (e) => {
          e.stopPropagation(); // Prevent triggering the pill click
          removeSecret(company, email);
        };

        pill.appendChild(removeBtn);
        container.appendChild(pill);
      }

      /**
       * Populate form fields with existing secret data for editing
       */
      function populateFormFields(company, email) {
        google.script.run
          .withSuccessHandler(response => {
            if (response.success) {
              // Set edit mode
              isEditMode = true;
              editingCompany = company;
              editingEmail = email;

              // Populate the form fields
              document.getElementById('company').value = response.company || '';
              document.getElementById('email').value = response.email || '';
              document.getElementById('password').value = response.password || '';
              // Clear secret seed field - seed is immutable
              document.getElementById('secretSeed').value = '';
              document.getElementById('secretSeed').placeholder = 'Seed cannot be changed for existing entries';
              document.getElementById('secretSeed').disabled = true;

              document.getElementById('save-secret').textContent = 'Update Entry';
              document.getElementById('cancel-edit').style.display = 'inline-block';

              // Show feedback to user
              showFeedbackPopup('Form populated with existing data. Seeds cannot be changed.', 'info');
            } else {
              showFeedbackPopup('Error: ' + response.message, 'error');
            }
          })
          .withFailureHandler(error => {
            showFeedbackPopup('Error loading data: ' + error.message, 'error');
            console.error('Error loading secret for editing:', error);
          })
          .getSecretForEditing(company, email);
      }

      /**
       * Reset form to add new entry mode
       */
      function resetFormToAddMode() {
        isEditMode = false;
        editingCompany = null;
        editingEmail = null;

        // Clear all fields
        document.getElementById('company').value = '';
        document.getElementById('email').value = '';
        document.getElementById('password').value = '';
        document.getElementById('secretSeed').value = '';

        // Re-enable seed field
        document.getElementById('secretSeed').disabled = false;
        document.getElementById('secretSeed').placeholder = 'Enter secret provided on sign up';

        // Reset button text
        document.getElementById('save-secret').textContent = 'Save Secret';
        document.getElementById('cancel-edit').style.display = 'none';
      }

      /**
       * Remove a 2FA secret from the list
       */
      function removeSecret(company, email) {
        const displayName = company || email || 'this entry';

        if (!confirm(`Are you sure you want to remove the 2FA code for ${displayName}?`)) {
          return;
        }

        google.script.run
          .withSuccessHandler(response => {
            if (response.success) {
              showFeedbackPopup(response.message, 'success');
              // Remove the pill from the UI immediately
              const pill = document.querySelector(`[data-company="${company}"][data-email="${email}"]`);
              if (pill) {
                pill.remove();
              }
              // Also reload the full list to ensure consistency
              loadCodesList();
            } else {
              showFeedbackPopup('Error: ' + response.message, 'error');
            }
          })
          .withFailureHandler(error => {
            showFeedbackPopup('Error: ' + error.message, 'error');
            console.error('Remove secret failed:', error);
          })
          .removeSecret(company, email);
        
      }

      /**
       * Save user name for the selected user
       */
      function saveUserName() {
        const selectedValue = document.getElementById('user-select').value;
        const newName = document.getElementById('selected-user-name').value.trim();
        
        if (!selectedValue || selectedValue.startsWith('GROUP:')) {
          showFeedbackPopup('Please select a user to update their name.', 'error');
          return;
        }
        
        if (!newName) {
          showFeedbackPopup('Please enter a valid name.', 'error');
          return;
        }

        google.script.run
          .withSuccessHandler(result => {
            if (result.success) {
              showFeedbackPopup('User name updated successfully!', 'success');
              // Reload the users list to reflect the name change in dropdown
              loadUsersList();
            } else {
              showFeedbackPopup(result.message || 'Failed to update user name.', 'error');
            }
          })
          .withFailureHandler(error => {
            console.error('Error updating user name:', error);
            showFeedbackPopup('Error updating user name. Please try again.', 'error');
          })
          .updateUserName(selectedValue, newName);
      }
    </script>